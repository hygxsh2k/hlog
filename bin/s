#!/usr/bin/env perl

use strict;
use warnings;
use autodie;
use v5.26;
use Storable;
use IPC::Open3;
use IO::Compress::Gzip;

my $hlog_file = $ENV{HLOG} // "$ENV{HOME}/.hlog";
store {}, $hlog_file if (not -e $hlog_file);
my $hlog = retrieve $hlog_file;

my ($wtr, $rdr, $err);
my $cmd = join ' ', @ARGV;
my $pid = open3($wtr, $rdr, $err, $cmd);
close $wtr;

waitpid $pid, 0;
my $cmd_out = '';
while(<$rdr>) {
	print;
	$cmd_out .= $_;
}
close $rdr;

unshift @{$hlog->{$cmd}}, $cmd_out;
splice  @{$hlog->{$cmd}}, 3;

$hlog->{'$_'} = $cmd;

store $hlog, $hlog_file;
